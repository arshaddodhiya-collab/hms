<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-card header="Patient Quick Registration">
  <form [formGroup]="form" (ngSubmit)="submit()">
    <p-divider align="left"><b>Patient Details</b></p-divider>

    <div class="grid">
      <div class="col-12 md:col-2">
        <p-dropdown
          formControlName="title"
          [options]="titles"
          placeholder="Title*"
        ></p-dropdown>
        @if (form.get('title')?.touched && form.get('title')?.invalid) {
        <small class="p-error block"> Title is required </small>
        }
      </div>

      <div class="col-12 md:col-2">
        <p-dropdown
          formControlName="gender"
          [options]="genders"
          placeholder="Gender*"
          [filter]="true"
        ></p-dropdown>
        @if (form.get('gender')?.touched && form.get('gender')?.invalid) {
        <small class="p-error block"> Gender is required </small>
        }
      </div>

      <div class="col-12 md:col-3">
        <input
          pInputText
          placeholder="First Name*"
          formControlName="firstName"
          class="w-full"
        />
        @if (form.get('firstName')?.touched && form.get('firstName')?.invalid) {
        <small class="p-error block"> Name is required </small>
        }
      </div>

      <div class="col-12 md:col-2">
        <input
          pInputText
          placeholder="Middle Name"
          formControlName="middleName"
          class="w-full"
        />
      </div>

      <div class="col-12 md:col-3">
        <input
          pInputText
          placeholder="Last Name*"
          formControlName="lastName"
          class="w-full"
        />
        @if (form.get('lastName')?.touched && form.get('lastName')?.invalid) {
        <small class="p-error block"> Last Name is required </small>
        }
      </div>
    </div>

    <div class="grid mt-2">
      <div class="col-12 md:col-3">
        <p-calendar
          formControlName="dob"
          placeholder="DOB*"
          [showIcon]="true"
        ></p-calendar>
        @if (form.get('dob')?.touched && form.get('dob')?.hasError('required'))
        {
        <small class="p-error block"> DOB is required </small>
        } @if (form.get('dob')?.touched && form.get('dob')?.hasError('minAge'))
        {
        <small class="p-error block"> Must be 18 years or older </small>
        }
      </div>

      <div class="col-12 md:col-3">
        <p-inputMask
          mask="(999) 999-9999"
          formControlName="contactNumber"
          placeholder="Contact Number*"
          styleClass="w-full"
        ></p-inputMask>
        @if (form.get('contactNumber')?.touched &&
        form.get('contactNumber')?.invalid) {
        <small class="p-error block"> Valid contact number required </small>
        } @if (form.get('contactNumber')?.hasError('uniqueContact')) {
        <small class="p-error block">
          Contact number already registered (ends with 000)
        </small>
        }
      </div>

      <div class="col-12 md:col-3">
        <input
          pInputText
          placeholder="Nationality*"
          formControlName="nationality"
          class="w-full"
        />
      </div>
    </div>

    <p-divider align="left"><b>Present Address</b></p-divider>
    <app-address formControlName="address"></app-address>

    <div class="field-checkbox mt-3">
      <p-checkbox
        formControlName="sameAsPermanent"
        [binary]="true"
        inputId="binary"
      ></p-checkbox>
      <label for="binary" class="ml-2"
        >Permanent Address same as Present Address</label
      >
    </div>

    <div class="mt-2">
      @if (!form.get('sameAsPermanent')?.value) {
      <p-divider align="left"><b>Permanent Address</b></p-divider>
      <app-address formControlName="permanentAddress"></app-address>
      }
    </div>

    <p-divider align="left">
      <div class="flex align-items-center justify-content-between">
        <b>Emergency Contacts</b>
        <button
          pButton
          type="button"
          icon="pi pi-plus"
          class="p-button-text p-button-sm"
          label="Add Contact"
          (click)="addEmergencyContact()"
        ></button>
      </div>
    </p-divider>

    <div formArrayName="emergencyContacts">
      @for (contact of emergencyContacts.controls; track i; let i = $index) {
      <div [formGroupName]="i" class="grid align-items-center mb-2">
        <div class="col-12 md:col-3">
          <input
            pInputText
            placeholder="Name*"
            formControlName="name"
            class="w-full"
          />
        </div>
        <div class="col-12 md:col-3">
          <input
            pInputText
            placeholder="Relation*"
            formControlName="relation"
            class="w-full"
          />
        </div>
        <div class="col-12 md:col-3">
          <p-inputMask
            mask="(999) 999-9999"
            formControlName="contactNumber"
            placeholder="Phone*"
            styleClass="w-full"
          ></p-inputMask>
        </div>
        <div class="col-12 md:col-1">
          <button
            pButton
            type="button"
            icon="pi pi-trash"
            class="p-button-danger p-button-text"
            (click)="removeEmergencyContact(i)"
          ></button>
        </div>
      </div>
      } @if (emergencyContacts.controls.length === 0) {
      <div class="text-500 font-italic">No emergency contacts added.</div>
      }
    </div>

    <div class="flex justify-content-end gap-2 mt-4">
      <button
        pButton
        type="button"
        label="Reset"
        class="p-button-secondary"
        (click)="reset()"
      ></button>
      <button pButton type="submit" label="Submit Registration"></button>
    </div>
  </form>
</p-card>
